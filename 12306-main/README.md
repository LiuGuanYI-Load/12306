3.17  
开发 TicketService 服务 - 购票核心流程

1. **Redis缓存设计**：
    - **令牌桶**：限流策略，Redis Hash 结构，key = "TICKET_AVAILABILITY_TOKEN_BUCKET_{trainId}"，Map<起始站_终点站_座位类型, 余票数量>。
    - **余票缓存**：存储具体座位信息，与数据库结构一致，用于快速分配座位。

2. **购票流程**：
    - **责任链验证**：校验请求参数、用户信息、购票资格。
    - **抢占令牌**：使用lua从令牌桶扣减余票，若无令牌,返回下单座位类型，再看是不是十分钟之内已经刷新过令牌桶，  
    - 没有就去看数据库，如果库存大于当前请求的票数 但是当前令牌小于请求的票数  就删除令牌 等待下次重新刷新。
    - **锁定资源**：
        - **争抢本地锁**：减轻分布式锁压力，牺牲一定的全局有序性。
        - **争抢分布式锁**：以列车ID+座位类型为key加锁，优化锁粒度，提高并发能力。
    - **分配座位**：从余票缓存选择具体座位并标记为已锁定。
    - **生成订单**：远程调用订单服务创建订单，失败则回滚座位状态。
    - 分布式id的生成以及订单号的生成 
    - - 业务分布式id 类似雪花算法（time+datacenter+machId+sequence）：系统时间戳 拼接 节点次序 拼接  序列号（0~127）
    - - 订单号：分布式id拼接用户id后6位  后面六位当作数据库分片键
    - **支付成功**：扣减数据库余票库存。
    - **缓存更新**：通过Canal监听数据库Binlog，异步更新Redis余票缓存。
    

